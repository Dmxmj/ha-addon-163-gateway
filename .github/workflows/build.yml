name: Build HA Add-on

on:
  push:
    branches: [ main ]
    paths:
      - 'ha_to_163/**'  # 仅当插件目录变更时触发
      - '.github/workflows/build.yml'

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [amd64, armv7, aarch64, i386]  # 匹配 repository.json 中声明的架构

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
        # 若使用 GitHub Container Registry，替换为：
        # uses: docker/login-action@v3
        # with:
        #   registry: ghcr.io
        #   username: ${{ github.actor }}
        #   password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract version
        id: version
        run: |
          # 从 repository.json 中提取插件版本
          echo "VERSION=$(jq -r '.addons[0].version' repository.json)" >> $GITHUB_OUTPUT

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ./ha_to_163  # 插件 Dockerfile 所在目录（需确保存在）
          push: true
          platforms: linux/${{ matrix.arch }}
          tags: |
            # 镜像标签格式：<仓库名>/<插件名>:<版本>-<架构>
            your-docker-username/ha-to-163-gateway:${{ steps.version.outputs.VERSION }}-${{ matrix.arch }}
            your-docker-username/ha-to-163-gateway:latest-${{ matrix.arch }}

  update-repository:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Update repository.json (optional)
        run: |
          # 若需自动更新版本号，可在此处通过 jq 修改 repository.json
          # 示例：jq '.addons[0].version = "new-version"' repository.json > temp.json && mv temp.json repository.json

      - name: Commit changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update repository after build"
          file_pattern: "repository.json"
